---
title: "Virtual species paper analyses"
author: "Jan Salecker"
date: "8/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The spectre manuscript

The spectre manuscript will probably be focused around the description of the algorithm and the R package.
Thus, a technical usecase is need for several reasons:

* To provide an example how the algorithm can be used and how the inputs and outputs look like
* To assess the efficiency of the spectre algorithm under various scenarios
* To point out future directions of package development

In addition to Matthias (@mspngbrg) approach (investigating the BCI dataset), this draft uses the virtualspecies data generation approach (see `virtualspecies_01_simple.Rmd` and `virtualspecies_02_advanced.RMD`) to explore the spectre package.


## Executing


```{r packages, eval=FALSE}
library(spectre)
library(tidyverse)
library(future)
library(virtualspecies)
library(furrr)
library(clustermq)
library(landscapetools)

## Source spectre analysis functions (R folder)
sapply(list.files("../R", full.names = TRUE), source)
set.seed(3562347)
exec <- "HPC" # "HPC"
dir.hpc <- file.path("/home/uni08/jsaleck/spectre")
dir.cloud <- file.path("/home/jan/netlogo_jan/spectre_usecase")

## Constant parameters:
replicates <- 3
max_runs <- 50000 ##50k
energy_threshold <- 0
beta <- 0.75

## Variable parameters:
landscape_size <- c(5,15,25)
corr_within <- c(0,0.5,1)
corr_among <- c(0,0.05,0.1)
gamma <- c(100,200,300)
random_seeds <- round(runif(replicates) * 100000)

## Generate parameter matrix:
parameters <- expand.grid(landscape_size = landscape_size, 
                          corr_within = corr_within,
                          gamma = gamma, 
                          beta = beta,
                          corr_among = corr_among,
                          random_seeds = random_seeds)

if (exec == "local") {
  plan(multisession)
  results <- furrr::future_map_dfr(seq(nrow(parameters)), function(x) {
    virtualspecies_simfun(siminputrow = x, 
                          parameters = parameters,
                          max_runs = max_runs,
                          energy_threshold = energy_threshold,
                          writeRDS = FALSE,
                          outdir = dir.cloud)
  })
}
if (exec == "HPC") {
  
  maxjobs.hpc <- 2000
  njobs <- min(nrow(parameters), maxjobs.hpc)
  jobIDs <- seq(nrow(parameters))
  
  results <- clustermq::Q(fun = virtualspecies_simfun, 
                          siminputrow = jobIDs,
                          const = list(parameters = parameters,
                                       max_runs = max_runs,
                                       energy_threshold = energy_threshold,
                                       writeRDS = TRUE,
                                       outdir = dir.hpc),
                          export = list(), 
                          seed = 42, 
                          n_jobs = njobs, 
                          template = list(job_name = "spectre", # define jobname
                                          log_file = "spectre.log", # define logfile name
                                          queue = "medium",  # define HPC queue
                                          service = "normal", # define HPC service
                                          walltime = "48:00:00", # define walltime
                                          mem_cpu = "4000")) # define memory per cpu   
  results <- dplyr::bind_rows(results)
}

#### Restore results from rds files if neccessary:
#results <- purrr::map_dfr(list.files(dir.cloud, pattern = "rds", full.names = TRUE), function(x) {
#  res.x <- readRDS(x)
#  return(res.x)
#})

#### STORE RESULTS:
saveRDS(results, file=file.path(dir.cloud, "data", "virtualspecies_03_manuscript_data.rds"))

```

## Analysis


```{r load.data, include=FALSE}
library(tidyverse)
sapply(list.files("../R", full.names = TRUE), source)
results <- readRDS("../data/virtualspecies_03_manuscript_data.rds")
```

#### Species richness of simulated species grids

```{r calc.sr, include=FALSE}
sr <- purrr::map_dfr(1:nrow(results), function(x) {
  
  landscape_size <- results$landscape_size[x]
  corr_within <- results$corr_within[x]
  corr_among <- results$corr_among[x]
  gamma <- results$gamma[x]
  beta <- results$beta[x]
  random_seeds <- results$random_seeds[x]
  
  sr <- raster::as.data.frame(sum(results$spp.virtual[[x]]), xy=TRUE) %>% 
    dplyr::rename(alpha=layer) %>% 
    dplyr::mutate(landscape_size = landscape_size) %>% 
    dplyr::mutate(corr_within = corr_within) %>% 
    dplyr::mutate(corr_among = corr_among) %>%
    dplyr::mutate(gamma = gamma) %>% 
    dplyr::mutate(beta = beta) %>% 
    dplyr::mutate(random_seeds = random_seeds)

  return(sr)
})

sr$corr_within <- factor(sr$corr_within,
                        levels = unique(sr$corr_within),
                        labels = paste0(unique(sr$corr_within), " within"))

sr$corr_among <- factor(sr$corr_among,
                        levels = unique(sr$corr_among),
                        labels = paste0(unique(sr$corr_among), " among"))

sr$landscape_size <- factor(sr$landscape_size,
                                 levels = unique(sr$landscape_size),
                                 labels = paste0(unique(sr$landscape_size), " x ", unique(sr$landscape_size)))
sr$gamma <- factor(sr$gamma,
                        levels = unique(sr$gamma),
                        labels = paste0(unique(sr$gamma), " species"))
```

```{r plot.sr}
for(i in unique(sr$landscape_size)) {
  sr %>% 
  dplyr::filter(landscape_size==i) %>% 
ggplot2::ggplot(., ggplot2::aes(x=x, y=y, fill=alpha)) +
  facet_grid(random_seeds+gamma~corr_within+corr_among) +
        ggplot2::geom_tile() +
        ggplot2::coord_equal() +
        #ggplot2::guides(fill="none") +
        ggplot2::scale_fill_viridis_c(option="D") +
        ggplot2::theme_void()  
ggsave(paste0("../figures/virtualspecies_03_manuscript_01_sr_", strsplit(i, " ")[[1]][1], ".png"), width=10, height=10, dpi=300)
}
```

#### Minimum energy

```{r calc.min.energy, include=FALSE}
energy <- purrr::map_dfr(1:nrow(results), function(x) {
  energy <- results$spp.spectre[[x]]$energy %>% 
    dplyr::mutate(landscape_size = results$landscape_size[x]) %>% 
    dplyr::mutate(corr_within = results$corr_within[x]) %>% 
    dplyr::mutate(corr_among = results$corr_among[x]) %>%
    dplyr::mutate(gamma = results$gamma[x]) %>% 
    dplyr::mutate(beta = results$beta[x]) %>% 
    dplyr::mutate(random_seeds = results$random_seeds[x])
})
## Add labels to factors
energy$landscape_size <- factor(energy$landscape_size,
                                 levels = unique(energy$landscape_size),
                                 labels = paste0(unique(energy$landscape_size), " x ", unique(energy$landscape_size)))
energy$gamma <- factor(energy$gamma,
                        levels = unique(energy$gamma),
                        labels = paste0(unique(energy$gamma), " species"))

## PLOT 1: Minimum energy
energy_min <- energy %>% 
  dplyr::group_by(landscape_size, gamma, corr_within, corr_among, random_seeds) %>% 
  dplyr::summarise(energy = min(energy)) %>% 
  dplyr::group_by(landscape_size, gamma, corr_within, corr_among) %>% 
  dplyr::summarise(energy = mean(energy))
```  

```{r plot.min.energy}
ggplot(energy_min, aes(x=factor(corr_within), y=factor(corr_among), fill=energy)) +
  facet_grid(landscape_size~gamma) +
  geom_tile() +
  geom_text(aes(label=round(energy,2))) +
  coord_equal() +
  xlab("correlation within species") +
  ylab("correlation among species") +
  ggthemes::scale_fill_continuous_tableau(palette="Red-Gold") +
  ggthemes::theme_tufte(base_size = 12)

ggsave("../figures/virtualspecies_03_manuscript_02_min_energy.png", width=6, height=6, dpi=300)
```


#### Realtive commonness error

```{r calc.rec, include=FALSE}
## PLOT 2: Relative error in commonness
results_rec <- purrr::map_dfr(1:nrow(results), function(x) {
  out.tib <- results[x,]
  spp <- results$spp.virtual[[x]]
  solution <- spectre::generate_data_virtualspecies_to_solution(spp)
  target <- spectre:::calculate_solution_commonness_rcpp(solution)
  optimized_grid <- results$spp.spectre[[x]]$optimized_grid
  out.tib$rec <- calculate_rec(target, optimized_grid)
  return(out.tib)
})

results_rec <- results_rec %>% 
  dplyr::group_by(landscape_size, gamma, corr_within, corr_among) %>% 
  dplyr::summarise(rec = mean(rec))

results_rec$landscape_size <- factor(results_rec$landscape_size,
                                    levels = unique(results_rec$landscape_size),
                                    labels = paste0(unique(results_rec$landscape_size), "x", unique(results_rec$landscape_size)))
results_rec$gamma <- factor(results_rec$gamma,
                           levels = unique(results_rec$gamma),
                           labels = paste0(unique(results_rec$gamma), " species"))
```

```{r plot.rec}
ggplot(results_rec, aes(x=factor(corr_within), y=factor(corr_among), fill=rec)) +
  facet_grid(landscape_size~gamma) +
  geom_tile() +
  geom_text(aes(label=round(rec,2))) +
  coord_equal() +
  xlab("correlation within species") +
  ylab("correlation among species") +
  ggthemes::scale_fill_continuous_tableau(palette="Red-Gold") +
  ggthemes::theme_tufte(base_size = 12)
ggsave("../figures/virtualspecies_03_manuscript_03_rec.png", width=6, height=6, dpi=300)

```

