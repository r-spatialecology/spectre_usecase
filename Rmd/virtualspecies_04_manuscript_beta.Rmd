---
title: "Virtual species paper analyses"
author: "Jan Salecker"
date: "8/31/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The spectre manuscript

The spectre manuscript will probably be focused around the description of the algorithm and the R package.
Thus, a technical usecase is need for several reasons:

* To provide an example how the algorithm can be used and how the inputs and outputs look like
* To assess the efficiency of the spectre algorithm under various scenarios
* To point out future directions of package development

In addition to Matthias (@mspngbrg) approach (investigating the BCI dataset), this draft uses the virtualspecies data generation approach (see `virtualspecies_01_simple.Rmd` and `virtualspecies_02_advanced.RMD`) to explore the spectre package.

In this new "beta" version of the experiment, we decided to include the beta parameter of the virtualspecies package into our experiment. Earlier investigations showed that beta has much more influence on the results, than for example the correlaiton within species. However, adding another layer of variation to the figures will not work. Thus, we decided to drop the factor with the least effetc on our outputs. This is corr_within, so we fix that to 0.5 and vary beta from 0.5-0.7 instead.


## Executing


```{r packages, eval=FALSE}
library(spectre)
library(tidyverse)
library(future)
library(virtualspecies)
library(furrr)
library(clustermq)
library(landscapetools)

## Source spectre analysis functions (R folder)
sapply(list.files("../R", full.names = TRUE), source)
set.seed(3562347)
exec <- "HPC" # "HPC"
dir.hpc <- file.path("/home/uni08/jsaleck/spectre")
dir.cloud <- file.path("/home/jan/netlogo_jan/spectre_usecase")

## Constant parameters:
replicates <- 3
max_runs <- 50000 ##50k
energy_threshold <- 0
corr_within <- 0.5

## Variable parameters:
landscape_size <- c(10,20,30)
beta <- c(0.5,0.6,0.7)
corr_among <- c(0.1,0.3,0.5)
gamma <- c(100,200,300)
random_seeds <- round(runif(replicates) * 100000)

## Generate parameter matrix:
parameters <- expand.grid(landscape_size = landscape_size, 
                          corr_within = corr_within,
                          gamma = gamma, 
                          beta = beta,
                          corr_among = corr_among,
                          random_seeds = random_seeds)

if (exec == "local") {
  plan(multisession)
  results <- furrr::future_map_dfr(seq(nrow(parameters)), function(x) {
    virtualspecies_simfun(siminputrow = x, 
                          parameters = parameters,
                          max_runs = max_runs,
                          energy_threshold = energy_threshold,
                          writeRDS = FALSE,
                          outdir = dir.cloud)
  })
}
if (exec == "HPC") {
  
  maxjobs.hpc <- 2000
  njobs <- min(nrow(parameters), maxjobs.hpc)
  jobIDs <- seq(nrow(parameters))
  
  results <- clustermq::Q(fun = virtualspecies_simfun, 
                          siminputrow = jobIDs,
                          const = list(parameters = parameters,
                                       max_runs = max_runs,
                                       energy_threshold = energy_threshold,
                                       writeRDS = TRUE,
                                       outdir = dir.hpc),
                          export = list(), 
                          seed = 42, 
                          n_jobs = njobs, 
                          template = list(job_name = "spectre", # define jobname
                                          log_file = "spectre.log", # define logfile name
                                          queue = "medium",  # define HPC queue
                                          service = "normal", # define HPC service
                                          walltime = "48:00:00", # define walltime
                                          mem_cpu = "4000")) # define memory per cpu   
  results <- dplyr::bind_rows(results)
}

#### Restore results from rds files if neccessary:
#results <- purrr::map_dfr(list.files(dir.cloud, pattern = "rds", full.names = TRUE), function(x) {
#  res.x <- readRDS(x)
#  return(res.x)
#})

#### STORE RESULTS:
saveRDS(results, file=file.path(dir.cloud, "data", "virtualspecies_04_manuscript_data.rds"))

```

## Analysis

We first need to load the data that was processed by the HPC.

```{r load.data, include=FALSE}
library(tidyverse)
sapply(list.files("../R", full.names = TRUE), source)
results <- readRDS("../data/virtualspecies_04_manuscript_data.rds")
plotdir <- "../figures/virtualspecies_manuscript_beta"
```

#### Species richness of simulated species grids

Here we plot the species distribution of the virtualspecies communities that were analysed.

```{r calc.sr, include=FALSE}
sr <- purrr::map_dfr(1:nrow(results), function(x) {
  
  landscape_size <- results$landscape_size[x]
  corr_within <- results$corr_within[x]
  corr_among <- results$corr_among[x]
  gamma <- results$gamma[x]
  beta <- results$beta[x]
  random_seeds <- results$random_seeds[x]
  
  sr <- raster::as.data.frame(sum(results$spp.virtual[[x]]), xy=TRUE) %>% 
    dplyr::rename(alpha=layer) %>% 
    dplyr::mutate(landscape_size = landscape_size) %>% 
    dplyr::mutate(corr_within = corr_within) %>% 
    dplyr::mutate(corr_among = corr_among) %>%
    dplyr::mutate(gamma = gamma) %>% 
    dplyr::mutate(beta = beta) %>% 
    dplyr::mutate(random_seeds = random_seeds)

  return(sr)
})

sr$beta <- factor(sr$beta,
                        levels = unique(sr$beta),
                        labels = paste0(unique(sr$beta), " beta"))

sr$corr_among <- factor(sr$corr_among,
                        levels = unique(sr$corr_among),
                        labels = paste0(unique(sr$corr_among), " among"))

sr$landscape_size <- factor(sr$landscape_size,
                                 levels = unique(sr$landscape_size),
                                 labels = paste0(unique(sr$landscape_size), " x ", unique(sr$landscape_size)))
sr$gamma <- factor(sr$gamma,
                        levels = sort(unique(sr$gamma)),
                        labels = paste0(sort(unique(sr$gamma)), " species"))
```

```{r plot.sr}
for(i in unique(sr$landscape_size)) {
  sr %>% 
  dplyr::filter(landscape_size==i) %>% 
ggplot2::ggplot(., ggplot2::aes(x=x, y=y, fill=alpha)) +
  facet_grid(random_seeds+gamma~beta+corr_among) +
        ggplot2::geom_tile() +
        ggplot2::coord_equal() +
        #ggplot2::guides(fill="none") +
        ggplot2::scale_fill_viridis_c(option="D") +
        ggplot2::theme_void()  
ggsave(filename = paste0("communities_sr_", strsplit(i, " ")[[1]][1], ".png"), path = plotdir, width=10, height=10, dpi=300)
}
```

#### Minimum energy

```{r calc.min.energy, include=FALSE}
energy <- purrr::map_dfr(1:nrow(results), function(x) {
  energy <- results$spp.spectre[[x]]$energy %>% 
    dplyr::mutate(landscape_size = results$landscape_size[x]) %>% 
    dplyr::mutate(corr_within = results$corr_within[x]) %>% 
    dplyr::mutate(corr_among = results$corr_among[x]) %>%
    dplyr::mutate(gamma = results$gamma[x]) %>% 
    dplyr::mutate(beta = results$beta[x]) %>% 
    dplyr::mutate(random_seeds = results$random_seeds[x])
})
## Add labels to factors
energy$landscape_size <- factor(energy$landscape_size,
                                 levels = unique(energy$landscape_size),
                                 labels = paste0(unique(energy$landscape_size), " x ", unique(energy$landscape_size)))
energy$gamma <- factor(energy$gamma,
                        levels = sort(unique(energy$gamma)),
                        labels = paste0(sort(unique(energy$gamma)), " species"))

## PLOT 1: Minimum energy
energy_min <- energy %>% 
  dplyr::group_by(landscape_size, gamma, beta, corr_among, random_seeds) %>% 
  dplyr::summarise(energy = min(energy)) %>% 
  dplyr::group_by(landscape_size, gamma, beta, corr_among) %>% 
  dplyr::summarise(energy = mean(energy))
```  

```{r plot.min.energy}
ggplot(energy_min, aes(x=factor(beta), y=factor(corr_among), fill=energy)) +
  facet_grid(landscape_size~gamma) +
  geom_tile() +
  geom_text(aes(label=round(energy,2))) +
  coord_equal() +
  xlab("virtual species distribution width threshold") +
  ylab("correlation among species") +
  ggthemes::scale_fill_continuous_tableau(palette="Red-Gold") +
  ggthemes::theme_tufte(base_size = 12)

ggsave(filename="min_energy.png", path=plotdir, width=6, height=6, dpi=300)
```


#### Realtive commonness error

```{r calc.rce, include=FALSE}
## PLOT 2: Relative error in commonness
results_rce <- purrr::map_dfr(1:nrow(results), function(x) {
  out.tib <- results[x,]
  spp <- results$spp.virtual[[x]]
  solution <- spectre::generate_data_virtualspecies_to_solution(spp)
  target <- spectre:::calculate_solution_commonness_rcpp(solution)
  optimized_grid <- results$spp.spectre[[x]]$optimized_grid
  
  # Calculate mean commonness (mc), relatice commonness error (rce) and mean absolute commonness error (mae)
  out.tib$mc <- calculate_mc(target)
  out.tib$rce <- calculate_rce(target, optimized_grid)
  out.tib$mae <- calculate_mae(target, optimized_grid)
  
  return(out.tib)
})

# Aggregate across replicates (random seeds)
results_rce <- results_rce %>% 
  dplyr::group_by(landscape_size, gamma, beta, corr_among) %>% 
  dplyr::summarise(rce = mean(rce),
                   mae = mean(mae),
                   mc = mean(mc))

results_rce$landscape_size <- factor(results_rce$landscape_size,
                                    levels = unique(results_rce$landscape_size),
                                    labels = paste0(unique(results_rce$landscape_size), "x", unique(results_rce$landscape_size)))
results_rce$gamma <- factor(results_rce$gamma,
                           levels = unique(results_rce$gamma),
                           labels = paste0(unique(results_rce$gamma), " species"))
```

```{r plot.rec}
ggplot(results_rce, aes(x=factor(beta), y=factor(corr_among), fill=rce)) +
  facet_grid(landscape_size~gamma) +
  geom_tile() +
  geom_text(aes(label=round(rce,2))) +
  coord_equal() +
  xlab("virtual species distribution width threshold") +
  ylab("correlation among species") +
  guides(fill=guide_colorbar(title="RCE")) +
  ggthemes::scale_fill_continuous_tableau(palette="Red-Gold") +
  ggthemes::theme_tufte(base_size = 12)
ggsave(filename="rce.png", path=plotdir, width=6, height=6, dpi=300)

```
```{r plot.mae}
ggplot(results_rce, aes(x=factor(beta), y=factor(corr_among), fill=mae)) +
  facet_grid(landscape_size~gamma) +
  geom_tile() +
  geom_text(aes(label=round(mae,1))) +
  coord_equal() +
  xlab("virtual species distribution width threshold") +
  ylab("correlation among species") +
  guides(fill=guide_colorbar(title="MAE")) +
  ggthemes::scale_fill_continuous_tableau(palette="Red-Gold") +
  ggthemes::theme_tufte(base_size = 12)
ggsave(filename="mae.png", path=plotdir, width=6, height=6, dpi=300)

```
```{r plot.mc}
ggplot(results_rce, aes(x=factor(beta), y=factor(corr_among), fill=mc)) +
  facet_grid(landscape_size~gamma) +
  geom_tile() +
  geom_text(aes(label=round(mc,1))) +
  coord_equal() +
  xlab("virtual species distribution width threshold") +
  ylab("correlation among species") +
  guides(fill=guide_colorbar(title="MC")) +
  ggthemes::scale_fill_continuous_tableau(palette="Blue-Teal") +
  ggthemes::theme_tufte(base_size = 12)
ggsave(filename="mc.png", path=plotdir, width=6, height=6, dpi=300)

```


#### Compact plots for main text

For the main text we are not uintereste din all the details of the correlation levels.
So here we have a condensed version with less detail.


```{r plot.rce.main}


## Only investigate output for intermediate correlation settings:
results_main <- results #%>% 
  #dplyr::filter(beta == 0.6) %>% 
  #dplyr::filter(corr_among == 0.3)

## PLOT 2: Relative error in commonness
results_main <- purrr::map_dfr(1:nrow(results_main), function(x) {
  out.tib <- results_main[x,]
  spp <- results_main$spp.virtual[[x]]
  solution <- spectre::generate_data_virtualspecies_to_solution(spp)
  target <- spectre:::calculate_solution_commonness_rcpp(solution)
  optimized_grid <- results_main$spp.spectre[[x]]$optimized_grid
  
  # Calculate mean commonness (mc), relatice commonness error (rce) and mean absolute commonness error (mae)
  out.tib$mc <- calculate_mc(target)
  out.tib$rce <- calculate_rce(target, optimized_grid)
  out.tib$mae <- calculate_mae(target, optimized_grid)
  
  return(out.tib)
}) %>% 
  dplyr::select(landscape_size,gamma, rce, mae, mc) %>% 
  dplyr::group_by(landscape_size, gamma) %>% 
  dplyr::summarise(rce_mu = mean(rce), 
                   rce_sd = sd(rce),
                   mae_mu = mean(mae), 
                   mae_sd = sd(mae),
                   mc_mu = mean(mc), 
                   mc_sd = sd(mc))


results_main$landscape_size <- factor(results_main$landscape_size,
                                    levels = unique(results_main$landscape_size),
                                    labels = paste0(unique(results_main$landscape_size), "x",
                                                    unique(results_main$landscape_size)))
#results_rce$gamma <- factor(results_rce$gamma,
#                           levels = unique(results_rce$gamma),
#                           labels = paste0(unique(results_rce$gamma), " species"))


ggplot(results_main, aes(x=gamma, y=rce_mu, color=landscape_size, group=landscape_size)) +
  geom_pointrange(aes(ymin=rce_mu-rce_sd, ymax=rce_mu+rce_sd), size=1) +
  geom_line(size=1) +
  xlab("Gamma diversity (total number of species)") +
  ylab("RCE") +
  guides(color=guide_legend(title="Landscape size")) +
  ggthemes::scale_color_colorblind() +
  ggthemes::theme_tufte(base_size = 12)

ggsave(filename="maintext_01.png", path=plotdir, width=6, height=3, dpi=300)

```
